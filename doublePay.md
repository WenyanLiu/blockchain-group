
# 双花问题


### 什么是双花
在数字化货币系统中，由于数据的可复制性，使得系统可能存在同一笔数字资产因不当操作被重复使用的情况，这也称之为双花。

在现实世界中，我们在支付时如果同时发出两笔支出，是记两笔支出的钱，因为转账或付款可以说是实时的，而且是由银行这个唯一的中心机构来记账的，在你转账或者说付款时，先从你的账户里面扣款，再由银行去确认交易，所以不会存在一笔钱被重复为两笔来进行交易或花费。



### 比特币解决双花问题

而作为去中心化的点对点价值传输系统，比特币通过UTXO（区块链课堂第7问中有提到）、时间戳等技术的整合来解决双花问题。

> 1. 具体来说，当一笔交易被广播到区块链网络之后，接收到交易的节点会对交易进行验证，检查其是否被花费过，即是否存在于UTXO中。如果交易输出已不存在于未花费交易列表中，则验证失败。  
>2. 另一方面，为了防止一个UTXO被重复使用的情况，比特币网络中还引入了时间戳的概念。假设用户A将被认证为UTXO的1 BTC同时转账给B1、B2，两笔交易仅有一笔会成功完成，因为挖矿节点会选择性的记录优先接收到的或交付手续费更高的那笔交易。当交易被挖矿节点先后记录，根据时间戳的数据，最先被记录的交易才能成功验证。

### 以太坊如何解决双花

目前来看，以太坊与比特币相似，会对交易的余额进行判断

>
>1. 在worker.go进行区块组装时会提交交易（core.ApplyTransaction(),  state_processor.go）
>2. ApplyTransaction中会创建虚拟机环境，调用ApplyMessage实现交易
>3. 调用ApplyMessage方法调用TransitionDb方法
>4. TransitionDb会调用evm.Call执行转账，或者调用evm.Create创建合约
>5. evm.Call和evm.Create中都会通过canTransfer方法判断余额是否足够
>6. canTransfer会通过db.GetBalance查询账号地址的余额并判断是否足够支付
```
