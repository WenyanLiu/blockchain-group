# Ouroboros权益证明算法

Ouroboros权益证明（PoS）算法是协议中最重要的部分。它定义了节点达到账本状态共识的方式。

Ouroboros算法是唯一一个基于证明安全的区块链权益证明协议。

## 为什么要有权益证明

不选择比特币采用的工作量证明（PoW）而选择权益证明（PoS）最重要的原因是考虑了能源消耗。运行比特币协议非常消耗资源，据估计，一个比特币的转账所需要的能源是3.8个美国家庭一天消耗的能源。随着越来越多的比特币矿工将资金投入矿业，运行比特币协议的能源要求只会越来越高，它们挖矿的难度也会越来越大。这也是为什么研究人员尽力研究达成共识的替代算法，比如使用Bazantine Fault Tolerant（BFT）算法和PoS算法。

## 什么是权益证明算法

权益证明是生成区块的新方法。权益证明的核心思想是不要浪费电力来解决计算量大的问题，而是选择一个节点来产生一个新的区块，其概率与这个节点所拥有的币数量成正比。如果一个节点具有整数（`>0`）的股权，则被称为“权益所有人”。如果一个节点最终被选中来铸造新的区块，它被称为“slot领导者”。

#### 证明

“权益证明”的“证明”是指证明交易块是合法的。

#### 权益

“权益”指的是“节点上的地址所拥有的相对价值”。“相对价值”指的是“Cardano结算层系统中某个节点钱包上的价值除以总价值”。

## 关于SLOT领导者

有正资产的节点称作权益所有人，只有权益所有人能参与运行协议。权益所有人必须被选举为slot领导者才让区块链生成区块。Slot领导者监听到其他节点的交易信息，然后通过密钥生成一个交易区块发给全网。

Slot领导者类似比特币中的矿工，共识协议会确定谁、什么时候能挖矿、能挖到多少矿。

## EPOCHS和SLOTS

Ouroboros协议将物理时间划分为epochs，每个epoch又划分为slots。

```
+----------+----------+-------+----------+--------------------> t
|  slot 0  |  slot 1  |  ...  |  slot N  |

 \                                      / \
  -------------- epoch M ---------------   -- epoch M+1 -- ...
```

:warning: slot是相对较短的一段时间（例如20秒）。

每个slot有且只有一个领导者（slot leader，SL）：

```
+----------+----------+-------+----------+----> t
|  slot 0  |  slot 1  |  ...  |  slot N  |

    SL 0       SL 1               SL N
```

Slot领导者有独占权在他的slot内生成有一个且只有一个区块：

```
  +------+   +------+           +------+
  | Bl 0 |<--| Bl 1 |<-- ... <--| Bl N |
  +------+   +------+           +------+
+----------+----------+-------+----------+----> t
|  slot 0  |  slot 1  |  ...  |  slot N  |

    SL 0       SL 1               SL N
```

这意味着slot领导者的数量严格等于一个epoch内slots的数量（不妨设为`N`），因此不可能在一个epoch里面生成超过`N`个区块。

如果slot领导者错过了他的slot（例如在那个阶段它离线了），在下一次被选举为领导者之前，他没有权利再生成区块。

:warning: 可以有一个或多个slots是空的（即不生成区块），但在一个epoch期间，它必须生成大部分块（至少50%+1）。

## SLOT领导者选举是怎么工作的

Slot领导者从所有的权益所有人中选举。:warning:并不是所有的权益所有人能参与这次选举，只有有足够多的权益（例如总权益的2%）才有资格。这些权益所有人称为“候选人”。

在epoch的选举中会选举一个slot领导者参与下一次epoch。在epoch `N`结束的时候，谁是epoch `N+1`的slot领导者就能知道，并且这是不可更改的。

这样的选举是“公平抽签”；权益所有人中的任何一个都能成为slot领导者。但PoS中一个很重要的思想是，权益所有人拥有的权益越多，他被选举为slot领导者的可能性也就越大。

:warning: 同一个epoch，一个权益所有人可以被多次选做slot领导者。

#### 多方计算

选举过程的根本问题之一是无偏性。需要一些随机性作为选举的基础，这样选举的结果是随机的、公平的。问题是随机性从哪来？

多方计算（Multiparty Computation，MPC）方法用来实现随机性，每个参选人独立进行一个“投硬币”的行为，然后与其他参选人分享结果。思想是结果由每个参选人随机产生，但最终他们在值上达成一致。

#### 提交阶段

首先，参选人会生成一个密钥（特殊的随机值）。接着，参选人会“提交”包含加密份额以及密码的证明的消息。

然后，参选人会用迷药来签署这个提交，指定epoch编号，附上他的公钥。在这种情况下，每个人都可以知道谁创建了这个提交，以及这个提交属于哪个epoch。

随后，参选人会将其提交交给其他参选人，最终每个参选人都会拿到其他参选人的提交。

:warning: 这些提交将被放入区块中，也就是说它们会成为区块链的一部分。

#### 开启阶段

在这个阶段参选人发送一个“开启”状态，这是一个大家提交的特殊值。一个提交就像一个锁着的盒子（里面有一个秘密），需要一个开启的钥匙来打开这个盒子，获取里面的秘密。

:warning: 所有的开启都将被放入区块中，也就是说它们会成为区块链的一部分。

#### 恢复阶段

这是最后的阶段。

最终，参选者既有提交，也有开启。从理论上来说，一些参选者可能是对手。他可以发布他的提交，但**不**公开他的开启。

在这种情况下，诚实的参选者可以张贴份额来重建秘密。思想是：即使某些参选者是对手，选举也能成功结束。

随后，参选者验证提交，开启匹配，如果成功，从提交中提取秘密，并从这些秘密中形成种子（随机生成的字符串）。所以所有的参选者都会得到相同的种子，并且会被用于追随中本聪（Follow the Satoshi，FTS）算法。

#### 追随中本聪

在参选者获取种子（需要随机性）后，它们必须为下一个epoch选择特定的slot领导者。此时引入追随中本聪（FTS）算法：

```
         +-----+
SEED --->| FTS |---> ELECTED_SLOT_LEADERS
         +-----+
```

为了解释slot领导者是怎么被选中的，将最小的、原子级的币叫做“Lovelace”。基本上，因为slot领导者只能从权益所有者中选择，账本会生成币的分布。FTS是一个挑选币的可验证算法，当权益所有者`S`的币被选中时，`S`就成为一个slot领导者。很明显，`S`的币越多，他的币被选中的几率也就越大。

被称为“追随中本聪”算法的理由是因为在比特币中，货币的最小单位被称为“聪”，这是为了表彰比特币的发明人中本聪（Satoshi Nakamoto）。

## 大多数都是诚实的

协议的基本假设前提是大多数都是诚实的。这意味着至少有50%+1的协议的权益所有人是诚实的。在这种情况下，可以证明攻击者无法打破区块链的持久化和活跃度。

