# 共识机制

公有链环境下，传统的工作量证明机制（Proof-of-Work）会面临能源浪费、效率低下的问题，为了解决节点验证效率问题，权益证明机制（Proof-of-Stake）、代理权益证明机制（Delegated Proof-of-Stake）、实用拜占庭容错机制（Practical Byzantine Fault Tolerant）逐步被开发和采用。

##### POS

- Ouroboros
- Tindermint
- Algorand
- Thunderella



##### DPOS

- Bitshares
- Steemit
- EOS

##### PBFT

- Hyperledger
- NEO



# 交易验证机制

### 侧链及状态通道

该解决方案本质是将在区块链上发生的交易或运行的智能合约放在链下进行，交易双方通过开设链下通道的形式，进行小额、多笔次交易或智能合约运行，区块链仅作为结算层来处理最终交易，或在智能合约产生争议时在主链上进行公决，以此减轻主链负担。

典型案例包括比特币闪电网络、以太坊雷电网络、小蚁的 Trinity，以及“主链+侧链”结构的 Aelf 和阿希链，状态通道的典型案例包括被称为“欧洲以太坊”的 Aeternity。

目前，Rchain、Emotiq、Zilliqa 以及以太坊等项目均在状态分片、跨片通信等领域进行兼容方案的探索。



### 分片技术

分片技术将区块链网络切分成许多独立的小区域，称为“碎片”，并且每个碎片有专门的节点来维护，相当于把区块链分成了多个独立的区域，每个碎片只负责特定的事物。分片技术主要包括交易分片和状态分片两大层面。



###   母子链或分层架构

传统的公有链网络中，记账节点不仅需要负责完成交易清算，还需要承担运行智能合约及存储各类状态的职能。分层架构的本质是将交易清算及智能合约的运行、计算进行隔离，独立运行，分担原先节点的压力，该方案的最著名的提出者为卡尔达诺，其将区块链网络分成了“清算层”和“计算层”，清算层负责数字资产的交易和流动，计算层提供智能合约，身份认证，通信等功能，并方便开发者进行应用开发，目前卡尔达诺已完成清算层的部署。

母子链架构则是将区块链分成主链和子链，母链负责交易清算，并存在众多的子链，每一条子链负责不同智能合约的运行，可定义自己专属的共识机制及执行模块，同时子链相互独立，互不影响，达到并行处理效果，子链与母链定期进行通讯，由子链将信息同步确认至母链上，典型的案例包括墨客、本体及 Nuls等，墨客已于 4 月 30 日正式上线主网络，本体于 3 月 30 日上线测试网络，Nuls于 3 月 31 日上线测试网络。



###  隐私性 解决方案 进展

1 、 混币 （CoinJoin ）

2 、 环签名 （Ring Signature ）

3 、 零知识证明 （Zero-Knowledge Proof ）

4 、 隐形互联网 （Invisible Internet Project ）

​	Verge 币是基于比特币技术的开源匿名数字资产，通过洋葱网络（The Onion Router）和隐形互联网（Invisible Internet Project）技术隐藏个人信息，比如 IP 地址和地理位置等，实现快速匿名交易，并无法追溯交易历史。



### 互通性 解决方案 进展

##### 公证人机制 （Notary schemes ）

- 以瑞波为典型代表，其 Interledger 协议能连接不同账本，通过第三方“连接器”或“验证器”互相自由地传输货币。该协议采用密码算法用连接器为这两个记账系统创建资金托管，并通过受信任的一个或者一组团体向某记账系统声明另一记账系统上发生了某事件，或者确定该声明是正确的，这些团体既可以自动地监听和响应事件，也可以在被请求的时候进行监听和响应事件。当所有参与方对交易达成共识时，便可相互交易。

##### 中继技术 （Relay） ） 

- 以 Cosmos 和 Polkadot 为典型。Cosmos是 Tendermint 团队推出的一个支持跨链交互的异构网络，以其核心链—“中心（Hub）”为中继，与其余的链—“空间（Zone）”共同构成一个链网架构。链网架构下，中心及各个空间可以通过区块链间通信协议（IBC）进行沟通，代币可以安全快速地从一个空间传递到另一个空间，空间内部所有代币的转移都会通过中心，并会记录每个空间所持有的代币总量。2018 年 5 月初，Cosmos 测试网络已进入 Gaia-5000 阶段，可进行验证者的出块奖励。

##### 侧链技术 （Sidechain）

- 侧链是以锚定某种原链上的数字资产为基础的新型区块链。假设 B 链能拥有 A 链的所有功能，则称 B 链为 A 链的侧链，A 链为 B 链的主链。其中主链 A并不知道侧链 B 的存在，侧链 B 知道有主链 A 的存在。通过将主链的区块链头写入侧链的区块中，让侧链使用和主链一样的共识验证方法，侧链便可以验证主链的交易。典型的侧链技术项目如比特币的侧链 Rootstock。

##### 哈希锁定技术 （Hash locking）

- 以闪电网络（Lightning network）、雷电网络（Raiden network）为典型，在跨链支付层面被莱特币所率先采用。其核心在于哈希锁定技术（Hash locking），即在不同的区块链之间架设链下的支付通道，双方若无直接的点对点支付通道，只要网络中存在一条连通双方的、由多个支付通道构成的支付路径，闪电网络也可以利用这条支付路径实现资金在双方之间的转移。由于比特币和以太坊等区块链网络各自使用了不同的网络协议，导致很难在异构的区块链网络间搭建闪电网络的通道，目前的跨链闪电网络通道，主要存在于莱特币和比特币之间。

#####  分布式私钥控制技术

- 以 Wanchain 和 Fusion 为典型。Wanchain 利用多方计算和门限密钥共享方案对跨链交易进行联合锚定，在不改变原有链机制的基础上通过跨链通信协议实现接入和交互。具体来说，对于转入交易，用户发起跨链交易请求，并将原链上的资产转入 Wanchain 位于原链的跨链锁定账户，之后用户可在Wanchain 上获得新创造的同等价值的智能合约 数字资产 ，进而可以使用相关应用或交易；对于转出交易，用户在Wanchain 上被创造的 数字资产清空，之后 Wanchain 位于原链的跨链锁定账户，会向用户提供的原链目标账户转入先前锁定的数字资产 ，等值的数字资产便会回到原有链。

- Fusion 则是通过分布式私钥生成与控制技术将各种数字资产映射到 Fusion 公有链上，这一过程称为锁入，而后可实现对多种数字资产的控制权管理，被映射的数字资产可在 Fusion 公有链进行自由交互，通过智能合约进行抵押、托管、借贷、衍生品等应用。最后，再通过解锁，将数字资产的控制权还给所有者，与 Wanchain 不同的是，整个过程不涉及所有权转让。

  ​

### 区块链 以外新的分布式账本底层

#### 有向无环图DAG



在区块链的应用上，DAG 图的每个顶点代表在某一个时间新挖出的区块。一般的线性区块链是 DAG 的一种特殊情况，也即每个时间段整个系统只能产生一个区块。不同的是，DAG 允许不同节点按自己的节奏生成区块，只要每个区块选择一个或多个区块作为自己的子区块。



3.1 双花
DAG 异步处理数据的特征导致攻击者可能利用节点间的信息差进行双花。具体来说，如果两个顶点间没有明确的父子关系，攻击者可以分别在只看到这两个顶点中的一个的不同节点处，对同一笔存款进行双花。这种双花只有在同时看到两个区块的节点处才能被检测到，并且只有在两个顶点重新汇合到一个新顶点时才能最终判定哪一笔是双花



3.2 影子链攻击
DAG 允许多重并行交易的特征，导致攻击者可能暗中生成一条影子链，并且时不时地将影子链跟主链进行对接以逃避检测算法。极端情况下，这条影子链有可能代替主链成为全网的共识。



|            | Byteball                           | IOTA                          | NANO           |
| ---------- | ---------------------------------- | ----------------------------- | -------------- |
| 共识机制   | 见证人                             | PoW（目前依赖协调             | DPoS+PoW       |
| 防双花     | 转账时必须包含之前                 | PoW+权重计算                  | DPoS 投票      |
| 防影子链   | 见证人宣布见到的顶点，投票选择主链 | MCMC 检测顶点与主链的耦合程度 | DPoS 投票      |
| 目前的问题 | 需要交易费                         | 哈希算法易遭到攻击            | 治理更为中心化 |

4.1 Byteball
Byteball 要求每当一个地址要进行转账时，它必须直接或间接包含所有之前从这个地址转出的交易记录。这样，如果攻击者进行双花，由于所有之前转账记录都包含在交易里，双花的检测就变得更容易了。我们只需要将第二笔转账同一存款的交易确定为双花就可以了。



为了防止攻击者暗中生成影子链并且链嫁接在主链上，Byteball 提出见证人（Witness）制度进行主链选择。每当见证人看到一个顶点，就公开宣布看到过这个顶点，而系统选择主链时就依照选择被见证次数最多的顶点的原则。



4.2 IOTA
IOTA 在防止双花上采取了不同的策略。IOTA 将主链的概念普遍化为扭结（tangle），实际上代表厚度任意的主链。在新顶点产生的时候，每个新顶点会选择 2 个旧顶点作为父顶点，并进行 PoW 挖矿。IOTA 在确定扭结时，按照所有的父顶点关系进行权重计算，给予较多子顶点支持的父顶点更多的权重



4.3 Nano
Nano 采取的 DAG 架构是给每个账户安排一条单独的链，这些链只有每当有发送或者接受转账时会更新相关交易的信息，这样每条链都只处理跟自己账户有关的交易，大大减少了需要处理的交易总量。Nano 使用 DPoS+PoW 混合共识机制， 一旦交易出现了争议由 DPoS 投票仲裁决定。Nano 设计成零交易费，所以为了防止垃圾交易，每笔交易入账需要进行一个小算力的 PoW 挖矿。

在实际应用中，Nano 的一账户一链架构给中心化交易所的出入金造成不便，因为交易所的账户会需要进行非常大量的交易，因此需要大量的 PoW 挖矿。Nano 目前的解决方法是手动免除交易所的 PoW 挖矿，但这种措施进一步加强了 Nano 网络对于中心化治理的依赖。



TrustNote

TrustNote 改进了 Byteball 的公证人制度，采用了双层共识机制，在传统 DAG 验证的基础上，引入了被称为 TrustME 的公证共识，由超级节点通过竞争的方式获得公证人的权利，同样依据 DAG 架构中排出的主链定序避免双花问题。



Hycon

韩国的基于 DAG 数据架构的底层公链平台项目，使用称作 SPECTRE的共识算法，在两组数据单元之间采用投票算法，以成对的方式对它们进行排序，以解决 DAG 异步记账模式下潜在的双花隐患。



CyberVein

在 DAG 数据架构的基础上附加可交互的智能合约，并使用自己的编程语言 Vein 和虚拟机 CBVM（CyberVein Virtual Machine）。与传统 DAG项目节点在发布数据单元前需要做简单的工作量证明不同，CyberVein引入贡献证明（Proof of Contribution），通过在网络中的贡献和适当的哈希计算，来决定交易费用的分配。





####   哈希图 （Hashgraph）

哈希图是由 Swirds 公司持有专利的一种分布式账本技术和数据结构，根据其独创的流言协议（gossip about gossip protocol），每个节点需将自己的交易信息传递给相邻节点，又将相邻节点的交易信息传递给其他节点；并且，每一笔交易信息都会附上需要传递的他人交易信息的哈希值，以及该节点自己最近一笔交易的哈希值，当所有节点完成信息传递，便可以达成共识，完成记账，这一过程被称为虚拟投票（Virtual Voting）。通过上述方式，哈希图解决了传统BFT 共识下消息复杂度高，大量消耗系统的网络带宽，无法很好的应对动态网络问题。

目前，哈希图主攻商业领域的联盟链，已在联盟链环境下实现二十五万笔每秒处理速度，然而其在大规模公有环境下运行仍有待验证。



哈希图具备如下特征：

- 哈希图仍采用拜占庭容错算法，属于完全异步的拜占庭容错 aBFT，1/3 的容错率，不良节点低于总节点数的 1/3，就能保证共识无误，但一旦有更多的节点作恶，系统便会崩溃。
- 相较于区块链体系记账时间通常与实际交易时间存在差异，例如在PoW 机制下，某一笔交易的优先级不够高，或者矿工费用较低，记账者就会优先打包其他交易，但哈希图机制下，实际交易时间与记账时间是一致的，交易发生后就传遍全网，便获得公认，因而更加公平。
- 无需挖矿，原先 PoW 的工作量证明机制，运行公有网络的成本高昂，同时，若两个矿工同时创建了两个区块，系统会默认选择最长的那条链，而丢弃另一个，造成浪费。





