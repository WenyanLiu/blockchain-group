# 《以太坊技术详解与实战》拾遗

## 第2章 以太坊架构和组成

### 2.3 账户

#### 2.3.1 外部账户

[Page 19]
生成一个账户地址的过程主要有三步。

1) 设置账户的私钥，也就是通常意义的用户密码。

2) 使用加密算法由私钥生成对应的公钥。

3) 根据公钥得出相应的账户地址。

其中第2步中使用的加密算法是secp256k1椭圆曲线密码算法，而不是RSA加密算法，因为前者相对于后者更加高效安全。对于由公钥得到账户地址，在以太坊中使用SHA3方法。

[Page 20]
```diff
用户自己列出自己创建的账户时，账户会
- 按字典序排序显示
+ 按照账户的创建时间先后排序。
```

#### 2.3.3 私钥和公钥

[Page 22]
目前常见的私钥有三种形态：Private Key、Keystore&Password以及Memonic code。

1) Private Key就是一份随机生成的256位二进制数字，用户甚至可以用纸笔来随机地生成一个私钥，即随机写下一串256位的仅包含“0”或“1”的字符串。该256位二进制数字就是私钥最初始的状态。

2) 而在以太坊官方钱包中，私钥和公钥将会以加密的方式保存一份JSON文件，存储在keystore子目录下。这份JSON文件就是Keystore，所以用户需要同时备份Keystore和对应的Password（创建钱包时设置的密码）。

3) 最后一种Memonic code是由BIP 39方案提出的，目的是随机生成12～24个比较容易记住的单词，该单词序列通过PBKDF2与HMAC-SHA512函数创建出随机种子，该种子通过BIP-0032提案的方式生成确定性钱包。

### 2.4 数据结构与存储

#### 2.4.1 数据组织形式

##### 1. Merkle树

[Page 24]
这棵树的建立从每个节点开始，:question:将节点两两分成多达16个组:question:，并对每个组求散列值，接着对散列结果继续求散列值，如此递归下去，直到整棵树有一个最后的“根散列值”。

##### 2. Trie树

[Page 25-26]
Radix树的优点有很多，其中一条就是：**如果有两个value，它们有着基于相同前缀的key，它们的相同前缀的长度占自身比例越大，则代表着这两个value在树中的位置越靠近，并且Trie树中不会有像散列表一样的冲突，也就是说一个key永远只对应一个value**。

##### 3. Merkle Patricia树

[Page 27]
利用存储的三颗MPT树，客户端可以轻松地查询以下内容。

* :question:查询某个地址在过去的30天中发出某种类型事件的所有实例:question:（例如，一个众筹合约完成了它的目标）。

[Page 28]
使用收据树。查询任务相对简单，:question:只需要服务器根据查询需求找到对象，获得对应的Merkle树分支，即可得到结果并返回给客户端。:question:

[Page 28]
:question:以太坊中的状态树每个节点最多有16个子节点，因此路径由十六进制编码决定:question:，如键“dog”的十六进制编码是[6,4,6,F,6,7]，其所代表的含义是从根节点开始到第6个分支，然后到第4个，再到第6个，再到第15个……这样依次查询，直到树的叶节点。

#### 2.4.2 状态树

[Page 29]
:question:状态树中的每个节点有16个孩子节点:question:，每个叶节点表示一个账户，这些叶节点的父节点由叶节点的散列组成，而这些父节点再组成更高一层的父节点，直至到形成根节点。

[Page 29]
尽管状态不直接存储在区块链中，但是它仍然是通过改进版本的MPT来维持的。

状态数据是一种隐式数据，意味着它需要从实际的区块链数据中计算出来。

#### 2.4.3 交易树

[Page 29]
“矿工”一般会根据交易的GasPrice和nonce对交易进行排序。首先会将交易列表中的交易划分到各个发送账户，每个账户的交易根据这些交易的nonce来排序。每个账户的交易排序完成后，再通过比较每个账户的第一条交易，选出最高价格的交易，这些是通过一个堆（heap）来实现的。

#### 2.4.4 收据树

[Page 29-30]
:question:logs是表格[address, [topic1, topic2, ...], data]元素的列表，表格由交易执行期间调用的操作码LOG0 ... LOG4生成（包含主调用和子调用），address是生成日志的合约地址，topic*n*是最多4个32字节的值，data是任意字节大小的数组。:question:

### 2.5 共识机制

#### 2.5.2 PoS

[Page 35-36]
相比于PoW，PoS有以下优点。

* 不需要为了保证区块链的安全而消耗大量的电力资源。由于消耗较少，通过发行新币以激励参与者继续参加网络活动的压力会减少，理论上:question:货币的负总发行量:question:成为可能。

### 2.7 交易

#### 2.7.1 交易费用

1. Gas

[Page 41]
图2-19是EVM一些常见操作对应的Gas消耗量，一些计算步骤也比其他计算步骤成本更高，因为这些步骤在计算上是昂贵的或者因为增加了在状态中需要存储的数据量。

[Page 42]
图2-19 常见操作与Gas消耗

:question:执行操作：Memory；Gas消耗：1；描述：扩充内存时每一个额外的字符费用:question:

#### 2.7.2 交易内容

[Page 43]
一条交易包含以下内容。

* from：交易发送者的地址，必填；
* to：交易接受者的地址，如果为空则意味这是一个创建智能合约的交易；
* value：发送者要转移给接收者的以太币数量；
* data（也写作input）：存在的数据字段，如果存在，则是表明该交易是一个创建或者调用智能合约交易；
* Gas Limit（也写作Gas，StartGas）：表示这个交易允许消耗的最大Gas数量；
* GasPrice：表示发送者愿意支付给矿工的Gas价格；
* nonce：用来区别同一用户发出的不同交易的标记；
* hash：由以上信息生成的散列值（哈希值），作为交易的ID；
* r、s、v：交易签名的三个部分，由发送者的私钥对交易hash进行签名生成。

## 第3章 不同类型的以太坊区块链及其部署

### 3.2 安装和部署以太坊

#### 3.2.2 部署以太坊联盟链

**1. 使用Geth部署以太坊联盟链**

(3) 搭建联盟链网络

[Page 72]
networkid参数为所连接的网络编号，这一编号需与创世区块文件中的chainId参数一致。

